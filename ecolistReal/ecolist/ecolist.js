var listref = null;var cartref = null;var user = null;var primedLists = false;firebase.auth().onAuthStateChanged( () => {user = firebase.auth().currentUser;if(user != null) {firebase.database().ref("users/" + user.uid).set({name:user.displayName});listref = firebase.database().ref("shoppinglist/" + user.uid + "/");cartref = firebase.database().ref("shoppingcart/" + user.uid + "/");console.log("logged in");if(!primedLists){listref.once("value").then(snapshot => {if(snapshot.exists() && snapshot.hasChildren()){snapshot.forEach( childSnapshot => {addRow(childSnapshot.key, childSnapshot.val());});}else {firebase.database().ref("shoppinglist/").update({[user.uid]: "empty"});console.log("created "+ user.displayName + "'s ecolist");};});cartref.once("value").then(snapshot => {if(snapshot.exists() && snapshot.hasChildren()){snapshot.forEach( childSnapshot => {addToCart(childSnapshot.key,childSnapshot.val());});$('#cTitle').html('Cart').hide().fadeIn("fast");}else {firebase.database().ref("shoppingcart/").update({[user.uid]: "empty"});console.log("created "+ user.displayName + "'s shoppingcart");};});primedLists = true;};} else console.log("not signed in");});function updateList() {if(user != null){var currentList = document.getElementsByClassName("form-control");var currentListLength = currentList.length - 1;var dblist = [];listref.once("value").then( snapshot=> {if(snapshot.exists() && snapshot.hasChildren()){snapshot.forEach(childSnapshot => {dblist[dblist.length] = childSnapshot.key;});for(a = 0; a < dblist.length; a++){for(j = 0; j < currentListLength; j += 2){if(currentList[j].value == undefined || currentList[j].value == null){currentList[j].value = "";};if(dblist[a] == currentList[j].value){dblist[a] = true;};};};for(var key of dblist){if(key !== true){listref.child(key).remove();};};};});for(i = 0;i < currentListLength; i += 2){if(currentList[i].value != undefined && currentList[i].value !=  null){var itemname = currentList[i].value;itemname = itemname.replace(/(\(\s?#\s?\)|\[\s?#\s?\])/g,"waffles");itemname = itemname.replace(/\//g,"\\");itemname = itemname.replace(/\[/g,"(");itemname = itemname.replace(/\]/g,")");itemname = itemname.replace(/(\.|#|\$)/g,"");itemname = itemname.replace(/\s{2,}/g," ");itemname = itemname.replace(/(^\s*\(\s*$|^\s*\)\s*$|^\s*\\\s*$)/g,"");itemname = itemname.replace(/\\\s*\\/g,"");itemname = itemname.replace(/\(\s*\)/g,"");currentList[i].value = itemname;if(currentList[i].value != ""){	var qnty = null;if(currentList[i+1].value == undefined || currentList[i+1].value == null || currentList[i+1].value == ""){qnty = 0;} else {qnty = parseInt(currentList[i+1].value);if(qnty < 0){qnty = Math.abs(qnty);currentList[i+1].value = qnty;};};if(currentList[i+1].value != undefined && currentList[i+1].value != null && currentList[i+1].value != ""){for(ii = currentListLength - 1; ii >  i; ii -= 2){if(currentList[ii].value == currentList[i].value){if(currentList[ii + 1].value == "" || currentList[ii + 1].value == undefined || currentList[ii + 1].value == null){amount = 0;}else{amount = parseInt(currentList[ii + 1].value);};currentList[i].value = "";currentList[i + 1].value = "";qnty += amount;currentList[ii +1].value = qnty;qnty = null;};};};if(qnty != null){listref.update({[currentList[i].value] : qnty});};};};};console.log("saved");};};